<!-- RUN WITH ALT + B -->>
<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon Template</title>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>

<body>
    <canvas id="renderCanvas" touch-action="none"></canvas> //touch-action="none" for best results from PEP
    <script>
        var canvas = document.getElementById("renderCanvas"); // Get the canvas element 
        var engine = new BABYLON.Engine(canvas, true); // Generate the BABYLON 3D engine
        function HexesToCord(a, b) {
            //a is up direction, y
            //b is side direction, +y, +x
            //c is side direction, -y, +x
            //1 Hexagon = 2.54 "units" inside this game
            //[d,e] is x, y
            var d = 0
            var e = 0
            d += 2.54 * (0.86602540378 * (b))
            e += 2.54 * (a + 0.5 * (b))
            return [d, e]
        }

        function intersect(a, b, map, type) {
            isit = false
            for (var q = -1; q < 2; q++) {
                for (var r = -1; r < 2; r++) {
                    if ((q != 1 && r != -1) || (q != -1 && r != 1)) {
                        if (map[50 + a + q][50 + b + r] == 1) {
                            isit = true
                        }
                    }
                }
            }
            if (type == 2) {
                if (map[50 + a + 1][50 + b + 1] == 1) {
                    isit = true
                }
            }
            if (type == 3) {
                if (map[50 + a + 1][50 + b + 1] == 1 ||
                    map[50 + a + 1][50 + b - 2] == 1 ||
                    map[50 + a - 1][50 + b + 2] == 1 ||
                    map[50 + a - 2][50 + b + 1] == 1 ||
                    map[50 + a - 1][50 + b - 1] == 1 ||
                    map[50 + a + 2][50 + b - 1] == 1) {
                    isit = true
                }
            }
            return isit
        }

        var value = 0; // by default
        var map = [...Array(100)].map(e => Array(100).fill(value));
        //y, x instead of x, y. remember that for map

        var createScene = function () {
            var scene = new BABYLON.Scene(engine);

            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, new BABYLON.Vector3(0, 0, 0), scene);
            camera.setPosition(new BABYLON.Vector3(0, 20, 50));
            camera.upperBetaLimit = (Math.PI / 2) * 0.9;
            camera.lowerRadiusLimit = 30;
            camera.upperRadiusLimit = 100;
            camera.attachControl(canvas, true);

            var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(0, 20, 50), scene);
            scene.clearColor = new BABYLON.Color3(0.5, 0.5, 0.8);
            const nummap = 16
            const Anum = 10
            const Bnum = 4
            const Cnum = 2

            var numqmap = 0
            var Aqnum = 0
            var Bqnum = 0
            var Cqnum = 0

            const Players = 4
            var Pnum = 0
            while (numqmap < nummap) {
                q = Math.random()
                if (q < 0.33 && Aqnum < Anum) {
                    BABYLON.SceneLoader.ImportMesh(
                        null,
                        "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                        "A.obj",
                        scene,
                        function (A) {
                            var mesh = A[0];
                            mesh.isVisible = false;
                            var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                            myMaterial.diffuseColor = new BABYLON.Color3(0.7, 0.7, 0.7)
                            mesh.material = myMaterial
                            var newInstance = mesh.createInstance("A" + Anum);
                            [a, b] = [0, 0]
                            while (intersect(a, b, map, 1) == true) {
                                d = Math.random()
                                if (d <= 0.25) {
                                    a += 1
                                } else if (d < 0.5) {
                                    a -= 1
                                } else if (d <= 0.75 + (Math.random() - 0.5) / 10) {
                                    b += 1
                                } else {
                                    b -= 1
                                }
                            }
                            [x, y] = HexesToCord(a, b)
                            newInstance.position.x = x
                            newInstance.position.z = y
                            newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                            for (var q = -1; q < 2; q++) {
                                for (var r = -1; r < 2; r++) {
                                    if ((q != 1 && r != -1) || (q != -1 && r != 1)) {
                                        map[50 + a + q][50 + b + r] = 1
                                    }
                                }
                            }
                        });
                    Aqnum += 1
                    numqmap += 1
                } else if (q < 0.66 && Bqnum < Bnum) {
                    BABYLON.SceneLoader.ImportMesh(
                        null,
                        "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                        "B.obj",
                        scene,
                        function (B) {
                            var mesh = B[0];
                            mesh.isVisible = false;
                            var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                            myMaterial.diffuseColor = new BABYLON.Color3(0.7, 0.7, 0.7)
                            mesh.material = myMaterial
                            var newInstance = mesh.createInstance("B" + Bnum);
                            [a, b] = [0, 0]
                            d = 0
                            while (intersect(a, b, map, 2) == true) {
                                d = Math.random()
                                if (d <= 0.25) {
                                    a += 1
                                } else if (d < 0.5) {
                                    a -= 1
                                } else if (d <= 0.75 + (Math.random() - 0.5) / 10) {
                                    b += 1
                                } else {
                                    b -= 1
                                }
                            }
                            [x, y] = HexesToCord(a, b)
                            offsetX = -2.54 * 3.935
                            offsetY = 2.54 * -3.935
                            offsetZ = 2.54 * 0.1
                            newInstance.position.x = x + offsetX
                            newInstance.position.z = y + offsetY
                            newInstance.position.y = offsetZ
                            newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                            for (var q = -1; q < 2; q++) {
                                for (var r = -1; r < 2; r++) {
                                    if ((q != 1 && r != -1) || (q != -1 && r != 1)) {
                                        map[50 + a + q][50 + b + r] = 1
                                    }
                                }
                            }
                            map[50 + a + 1][50 + b + 1] = 1
                        });
                    Bqnum += 1
                    numqmap += 1
                } else if (Cqnum < Cnum) {
                    BABYLON.SceneLoader.ImportMesh(
                        null,
                        "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                        "C.obj",
                        scene,
                        function (C) {
                            var mesh = C[0];
                            mesh.isVisible = false;

                            var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                            myMaterial.diffuseColor = new BABYLON.Color3(0.7, 0.7, 0.7)
                            mesh.material = myMaterial

                            var newInstance = mesh.createInstance("C" + Cnum);
                            [a, b] = [0, 0]
                            d = 0
                            while (intersect(a, b, map, 3) == true) {
                                d = Math.random()
                                if (d <= 0.25) {
                                    a += 1
                                } else if (d < 0.5) {
                                    a -= 1
                                } else if (d <= 0.75 + (Math.random() - 0.5) / 10) {
                                    b += 1
                                } else {
                                    b -= 1
                                }
                            }
                            [x, y] = HexesToCord(a, b)
                            offsetX = -2.54 * 3.935
                            offsetY = 2.54 * 0
                            offsetZ = 2.54 * 0
                            newInstance.position.x = x + offsetX
                            newInstance.position.z = y + offsetY
                            newInstance.position.y = offsetZ
                            newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                            for (var q = -1; q < 2; q++) {
                                for (var r = -1; r < 2; r++) {
                                    if ((q != 1 && r != -1) || (q != -1 && r != 1)) {
                                        map[50 + a + q][50 + b + r] = 1
                                    }
                                }
                            }
                            map[50 + a + 1][50 + b + 1] = 1
                            map[50 + a + 1][50 + b - 2] = 1
                            map[50 + a - 1][50 + b + 2] = 1
                            map[50 + a - 2][50 + b + 1] = 1
                            map[50 + a + 2][50 + b - 1] = 1
                            map[50 + a - 1][50 + b - 1] = 1
                        });
                    Cqnum += 1
                    numqmap += 1
                }
            }


            //Players, not map (while & forloop dont work, copy pase code 4 times)
            //RED Excavator
            BABYLON.SceneLoader.ImportMesh(
                null,
                "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                "Excavator.obj",
                scene,
                function (Exc) {
                    var mesh = Exc[0];
                    mesh.isVisible = false;

                    var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                    myMaterial.diffuseColor = new BABYLON.Color3(1, 0, 0)
                    mesh.material = myMaterial

                    var newInstance = mesh.createInstance("Exc" + 0);
                    [x, y] = HexesToCord(0, 0)
                    offsetX = -2.54 * 7.3
                    offsetY = -2.54 * 2.58
                    offsetZ = 2.54 * 0.3
                    newInstance.position.x = x + offsetX
                    newInstance.position.z = y + offsetY
                    newInstance.position.y = offsetZ
                    newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                    newInstance.picked = false
                    map[50][50] = 2

                });

            //YELLOW EXCAVATOR
            BABYLON.SceneLoader.ImportMesh(
                null,
                "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                "Excavator.obj",
                scene,
                function (Exc) {
                    var mesh = Exc[0];
                    mesh.isVisible = false;

                    var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                    myMaterial.diffuseColor = new BABYLON.Color3(1, 1, 0)
                    mesh.material = myMaterial

                    var newInstance = mesh.createInstance("Exc" + 1);
                    [x, y] = HexesToCord(1, 0)
                    offsetX = -2.54 * 7.3
                    offsetY = -2.54 * 2.58
                    offsetZ = 2.54 * 0.3
                    newInstance.position.x = x + offsetX
                    newInstance.position.z = y + offsetY
                    newInstance.position.y = offsetZ
                    newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                    newInstance.picked = false
                    map[50][51] = 2

                });

            //BLUE EXCAVATOR
            BABYLON.SceneLoader.ImportMesh(
                null,
                "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                "Excavator.obj",
                scene,
                function (Exc) {
                    var mesh = Exc[0];
                    mesh.isVisible = false;

                    var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                    myMaterial.diffuseColor = new BABYLON.Color3(0, 0, 1)
                    mesh.material = myMaterial

                    var newInstance = mesh.createInstance("Exc" + 2);
                    [x, y] = HexesToCord(2, 0)
                    offsetX = -2.54 * 7.3
                    offsetY = -2.54 * 2.58
                    offsetZ = 2.54 * 0.3
                    newInstance.position.x = x + offsetX
                    newInstance.position.z = y + offsetY
                    newInstance.position.y = offsetZ
                    newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                    newInstance.picked = false
                    map[52][50] = 2

                });

            //GREEN EXCAVATOR
            BABYLON.SceneLoader.ImportMesh(
                null,
                "https://raw.githubusercontent.com/Rizzist/HexagonWar/master/",
                "Excavator.obj",
                scene,
                function (Exc) {
                    var mesh = Exc[0];
                    mesh.isVisible = false;

                    var myMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
                    myMaterial.diffuseColor = new BABYLON.Color3(0, 1, 0)
                    mesh.material = myMaterial

                    var newInstance = mesh.createInstance("Exc" + 3);
                    [x, y] = HexesToCord(3, 0)
                    offsetX = -2.54 * 7.3
                    offsetY = -2.54 * 2.58
                    offsetZ = 2.54 * 0.3
                    newInstance.position.x = x + offsetX
                    newInstance.position.z = y + offsetY
                    newInstance.position.y = offsetZ
                    newInstance.rotate(BABYLON.Axis.X, -Math.PI / 2, BABYLON.Space.WORLD);
                    newInstance.picked = false
                    map[53][50] = 2

                });


            scene.onPointerDown = function (evt, pickResult) {
                // if the click hits the ground object, we change the impact position
                if (pickResult.hit) {
                    if (pickResult.pickedMesh.id == "Exc0") {
                        if (pickResult.pickedMesh.picked == false) {
                            scene.getMeshByID('Exc0').material.diffuseColor = new BABYLON.Color3(1, 0, 1)
                            scene.getMeshByID('Exc0').picked = true

                        }
                    } else {
                        scene.getMeshByID('Exc0').material.diffuseColor = new BABYLON.Color3(1, 0, 0)
                        scene.getMeshByID('Exc0').picked = false
                    }

                    if (pickResult.pickedMesh.id == "Exc1") {
                        if (pickResult.pickedMesh.picked == false) {
                            scene.getMeshByID('Exc1').material.diffuseColor = new BABYLON.Color3(1, 0, 1)
                            scene.getMeshByID('Exc1').picked = true

                        }
                    } else {
                        scene.getMeshByID('Exc1').material.diffuseColor = new BABYLON.Color3(1, 1, 0)
                        scene.getMeshByID('Exc1').picked = false
                    }

                    if (pickResult.pickedMesh.id == "Exc2") {
                        if (pickResult.pickedMesh.picked == false) {
                            scene.getMeshByID('Exc2').material.diffuseColor = new BABYLON.Color3(1, 0, 1)
                            scene.getMeshByID('Exc2').picked = true

                        }
                    } else {
                        scene.getMeshByID('Exc2').material.diffuseColor = new BABYLON.Color3(0, 0, 1)
                        scene.getMeshByID('Exc2').picked = false
                    }

                    if (pickResult.pickedMesh.id == "Exc3") {
                        if (pickResult.pickedMesh.picked == false) {
                            scene.getMeshByID('Exc3').material.diffuseColor = new BABYLON.Color3(1, 0, 1)
                            scene.getMeshByID('Exc3').picked = true

                        }
                    } else {
                        scene.getMeshByID('Exc3').material.diffuseColor = new BABYLON.Color3(0, 1, 0)
                        scene.getMeshByID('Exc3').picked = false
                    }
                }
            };


            scene.registerBeforeRender(function () {
                light.position = camera.position;
            });
            return scene;
        };
        var scene = createScene();
        engine.runRenderLoop(function () {
            scene.render();
        });
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>

</html>